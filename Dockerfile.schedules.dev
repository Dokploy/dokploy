# Development Dockerfile for Schedules Service
FROM node:20.16.0-slim AS dev
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable
RUN corepack prepare pnpm@9.12.0 --activate

# Install development dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/schedules/package.json ./apps/schedules/
COPY packages/server/package.json ./packages/server/

# Install dependencies with cache mount
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

# Copy source code
COPY apps/schedules/ ./apps/schedules/
COPY packages/server/ ./packages/server/

# Build the server package first (required by schedules service)
RUN pnpm --filter=@dokploy/server run build

# Set development environment
ENV NODE_ENV=development

WORKDIR /app/apps/schedules

# Expose port
EXPOSE 3002

# Create volume for node_modules to enable hot reloading
VOLUME ["/app/node_modules", "/app/apps/schedules/node_modules"]

# Development command with hot reloading using tsx watch
CMD ["pnpm", "exec", "tsx", "watch", "src/index.ts"]
