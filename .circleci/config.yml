version: 2.1

jobs:
  build-and-push-docker:
    machine:
      image: ubuntu-2004:current
      resource_class: arm.large
    steps:
      - checkout

      - run:
          name: Verify Docker version
          command: |
            docker version
            docker buildx inspect --bootstrap

      - run:
          name: Login to Docker Hub
          command: |
            docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN

      - run:
          name: Prepare .env file
          command: |
            cp .env.production.example .env.production

      # - run:
      #     name: Build and push Docker image
      #     command: |
      #       docker buildx build --platform linux/amd64,linux/arm64 -t dokploy/dokploy:testing --push .
      - run:
          name: Build and push Docker image using custom script
          command: |
            chmod +x ./docker/push.sh
            echo $CIRCLE_BRANCH
            ./docker/push.sh canary
            if [ "${CIRCLE_BRANCH}" = "canary" ]; then
              ./docker/push.sh canary
            else
              echo "PUSHING PRODUCTION"
              # ./docker/push.sh
            fi

workflows:
  build-and-push:
    jobs:
      - build-and-push-docker:
          filters:
            branches:
              only: feat/circle
