version: 2.1

jobs:
  build-and-push-docker:
    machine:
      image: ubuntu-2004:current
      resource_class: arm.large
    steps:
      - checkout

      - run:
          name: Instalar Docker
          command: |
            curl -sSL https://get.docker.com | sh
      - run:
          name: Verificar versi√≥n de Docker
          command: docker --version

      - run:
          name: Set up Docker Buildx
          command: |
            docker buildx create --name mybuilder --use
            docker buildx inspect --bootstrap

      - run:
          name: Login to Docker Hub
          command: |
            docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN

      - run:
          name: Prepare .env file
          command: |
            cp .env.production.example .env.production

      - run:
          name: Build and push Docker image
          command: |
            docker buildx build --platform linux/arm64 -t dokploy/dokploy:testing --push .

workflows:
  build-and-push:
    jobs:
      - build-and-push-docker:
          filters:
            branches:
              only: feat/circle
